<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Acompanhamento de Viagem - UberPB</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100vw; }
        .info-box {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            z-index: 1000;
            font-size: 14px;
        }
    </style>
</head>
<body>
<div id="map"></div>
<div id="info" class="info-box">Carregando dados da viagem...</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="dados_viagem.js"></script>

<script>
    // Inicializa o mapa, centralizado entre origem e destino
    const map = L.map('map').setView([(origem.lat + destino.lat) / 2, (origem.lon + destino.lon) / 2], 14);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Marcadores de Origem e Destino
    L.marker([origem.lat, origem.lon]).addTo(map).bindPopup(`<b>Origem:</b> ${origem.desc}`).openPopup();
    L.marker([destino.lat, destino.lon]).addTo(map).bindPopup(`<b>Destino:</b> ${destino.desc}`);

    // Rota (linha entre os pontos)
    L.polyline([[origem.lat, origem.lon], [destino.lat, destino.lon]], {color: 'blue'}).addTo(map);

    // Caixa de informações
    document.getElementById('info').innerHTML = `De: <b>${origem.desc}</b><br>Para: <b>${destino.desc}</b>`;

    // Ícone customizado para o carro
    const carIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/1048/1048314.png',
        iconSize: [38, 38]
    });

    // Marcador do Carro (começa na origem)
    const carMarker = L.marker([carro_pos.lat, carro_pos.lon], {icon: carIcon}).addTo(map);

    // Função para recarregar o script de dados e atualizar o mapa
    function atualizarPosicao() {
        // Cria um novo elemento de script para evitar cache
        const head = document.getElementsByTagName('head')[0];
        const oldScript = document.getElementById('trip-data-script');
        if (oldScript) {
            head.removeChild(oldScript);
        }

        const newScript = document.createElement('script');
        newScript.id = 'trip-data-script';
        // Adiciona um parâmetro aleatório para forçar o navegador a recarregar
        newScript.src = 'dados_viagem.js?' + new Date().getTime();
        head.appendChild(newScript);

        // Quando o novo script carregar, atualiza a posição do marcador
        newScript.onload = () => {
            carMarker.setLatLng([carro_pos.lat, carro_pos.lon]);
        };
    }

    // A cada 3 segundos, chama a função para atualizar a posição
    setInterval(atualizarPosicao, 3000);
</script>
</body>
</html>